rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    // Match any file path within the 'journal_media' folder for both images and videos
    match /journal_media/{mediaId} {
      
      // Allow anyone to read media files. This is required to display them in the app.
      allow read: if true;
      
      // Allow a user to WRITE (upload) media files only if:
      // 1. They are logged in.
      // 2. The file size is appropriate for the media type
      allow write: if request.auth != null && (
        // Images: up to 5MB
        (request.resource.contentType.matches('image/.*') && request.resource.size < 5 * 1024 * 1024) ||
        // Videos: up to 50MB  
        (request.resource.contentType.matches('video/.*') && request.resource.size < 50 * 1024 * 1024)
      );
    }
    
    // Profile images for user profiles - allow recursive paths
    match /profile_images/{userId}/{allPaths=**} {
      allow read: if true;
      allow write: if request.auth != null && request.auth.uid == userId
        && request.resource.contentType.matches('image/.*')
        && request.resource.size < 5 * 1024 * 1024;
    }
    
    // Profile images for child profiles - allow recursive paths
    match /child_images/{childId}/{allPaths=**} {
      allow read: if true;
      allow write: if request.auth != null
        && request.resource.contentType.matches('image/.*')
        && request.resource.size < 5 * 1024 * 1024;
    }
  }
}
